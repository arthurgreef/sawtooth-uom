FROM libsnark

WORKDIR /root

# install prerequisite
RUN apt-get update && apt-get install -y nano libpcre3-dev python3-dev python3-pip && \
	python3 -m pip install --upgrade pip && \
	mkdir -p /hashblock-exchange/zkSNARK

WORKDIR /hashblock-exchange/zkSNARK
COPY zkSNARK .

RUN cp -r ./hashblock_zksnark/src/ ~/libsnark/libsnark/zk_proof_systems/ppzksnark/r1cs_ppzksnark/hashblock/ && \
    perl -0pe 's/demo_r1cs_ppzkadsnark.*\n.*EXCLUDE_FROM_ALL/__PLACEHOLDER__/' ~/libsnark/libsnark/CMakeLists.txt > ~/libsnark/libsnark/r0.txt && \
	sed -e:b -e'$!{N;2,2bb' -e\} -e'/\n.*__PLACEHOLDER__/!P;D' ~/libsnark/libsnark/r0.txt > ~/libsnark/libsnark/r1.txt && \
	sed -e '/__PLACEHOLDER__/{n;N;N;N;N;N;N;N;N;d}' ~/libsnark/libsnark/r1.txt > ~/libsnark/libsnark/r2.txt && \
	sed 's/^.*__PLACEHOLDER__/if("${WITH_SUPERCOP}")\n  add_executable(\n    demo_r1cs_ppzkadsnark\nEXCLUDE_FROM_ALL\n\n    zk_proof_systems\/ppzkadsnark\/r1cs_ppzkadsnark\/examples\/demo_r1cs_ppzkadsnark.cpp\n  )\n  target_link_libraries(\n    demo_r1cs_ppzkadsnark\n\n    snark_adsnark\n  )\nendif()\n\nadd_executable(\n    hbzksnark\n\n    zk_proof_systems\/ppzksnark\/r1cs_ppzksnark\/hashblock\/hbzksnark.cpp\n    zk_proof_systems\/ppzksnark\/r1cs_ppzksnark\/hashblock\/base64.cpp\n  )\n  target_link_libraries(\n    hbzksnark\n\n    snark\n  )/' ~/libsnark/libsnark/r2.txt > ~/libsnark/libsnark/CMakeLists.txt

WORKDIR /root/libsnark
RUN rm -R build && \
	mkdir build && cd build && cmake .. && make && make install

WORKDIR /root/libsnark/build/libsnark
